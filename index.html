<html>
<head>
  <title>Spot-the-Lesion</title>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140347119-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-140347119-1');
  </script>

  <meta name="viewport" content="width=device-width"/>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.1/seedrandom.min.js"></script>
  <link rel="stylesheet" type="text/css" href="main.css?v=1.3">
  <!--  <script src="bbox_annotator.js"></script>-->
</head>
<body>
<div class="page-wrap">
  <h1 id="title">Spot-the-Lesion</h1>
  <div style="display: flex; flex-direction: row; justify-content: center;">
    <div class="item sidebar" id="item-1">
      <h3>Can you beat the AI?</h3>
	  
	  <h3>Instructions:</h3>
      <ol class="list">
        <li>You will be shown CT scans. Each will contain a single lesion.</li>
        <li>You have 10 seconds to find it and click on it.</li>
        <li>After 5 seconds a hint will appear.</li>
      </ol>

      <h3>Labels:</h3>
      <ul class="list">
        <li>A cross indicates where you have pressed, it will be green if you were correct and red otherwise.</li>
        <li>A yellow box indicates a lesion which has been labeled by a clinician.</li>
        <li>A green or a red box indicates the prediction of our AI. Green if its correct and red otherwise.</li>
        <li>A red circle gives you a hint about lesion location.</li>
      </ul>
    </div>
    <div class="item" id="item-2">
      <div id="initial">
        <div>
          <h3>Configuration:</h3>
          <div>
            <label>Random seed:
              <input id="seed">
            </label>
          </div>
          <button id="start">Start [S]</button>
        </div>
      </div>
      <div id="main" style="display: none;">
        <canvas id="canvas" width="512px" height="512px"></canvas>
        <div style="display: flex; flex-direction: row; justify-content: center;">
          <button id="next">Next [N]</button>
        </div>
      </div>
    </div>
    <div class="item sidebar" id="item-3">
      <h3 id="countdown">Time remaining: 10s</h3>

      <h3>Results</h3>
		<h4><div id="correct">Correct (you): 0</div></h4>
		<h4><div id="ourCorrect">Correct (AI): 0</div></h4>
		<h4><div id="total">Total Scans: 0</div></h4>
      
    </div>
  </div>
</div>
<footer class="site-footer">
  <a href="http://imperial.ac.uk" target="_blank"><img src="images/imperial.png" alt="Imperial Logo" class="footer-logo" style="position: absolute; left: 0;"></a>
  <a href="http://project-mira.eu" target="_blank"><img src="images/mira.png" alt="Imperial Logo" class="footer-logo" style="position: absolute; right: 0;"></a>
  <p id="attribution">This demo is based on our <a href="https://arxiv.org/abs/1906.02283" target="_blank">MICCAI 2019 paper</a>.<br>
  Developed by Martin Zlocha, Qi Dou and Ben Glocker. (c) 2019<br>  
  Data obtained from the <a href="https://www.nih.gov/news-events/news-releases/nih-clinical-center-releases-dataset-32000-ct-images" target="_blank">NIH Clinical Center</a></p>
</footer>
<script type="text/javascript">
  $(document).ready(function () {
    var canvas = document.getElementById("canvas");
    var next = document.getElementById("next");
    var ctx = canvas.getContext("2d");
    var hinted = false;
    var clicked = false;
    var started = false;
    var seed = 1;
    var truth;
    var predicted;
    var correct = 0;
    var our_correct = 0;
    var total = 0;
    var timeOuts = [];
    var countdown;
    var timeRemaining = 10;
    var seen = new Set();

    function random_file_number() {
      var max = 4817;
      // var max = 100;
      var value = Math.round(Math.random() * max);

      if (seen.has(value)) {
        return random_file_number();
      } else {
        seen.add(value);
        return value;
      }
    }

    function update_seed() {
      var x = Math.sin(seed++) * 10000;
      seed = x - Math.floor(x);
    }

    document.getElementById('start').addEventListener('click', function () {
      start();
    });

    next.addEventListener('click', function () {
      load_random_image();
    });

    function getMousePos(canvas, evt) {
      var rect = canvas.getBoundingClientRect(), // abs. size of element
        scaleX = canvas.width / rect.width,    // relationship bitmap vs. element for X
        scaleY = canvas.height / rect.height;  // relationship bitmap vs. element for Y

      return {
        x: (evt.clientX - rect.left) * scaleX,   // scale mouse coordinates after they have
        y: (evt.clientY - rect.top) * scaleY     // been adjusted to be relative to element
      }
    }

    canvas.addEventListener('click', function (evt) {
      draw_truth();
      stop_timer();

      if (timeRemaining <= 0 || clicked) {
        return;
      }
      clicked = true;

      // Cross for the mouse click
      ctx.beginPath();

      var position = getMousePos(canvas, evt);

      if (truth[0] <= position.x && position.x <= truth[2] && truth[1] <= position.y && position.y <= truth[3]) {
        correct += 1;
        ctx.strokeStyle = 'green';
      } else {
        ctx.strokeStyle = 'red';
      }

      ctx.moveTo(position.x - 5, position.y - 5);
      ctx.lineTo(position.x + 5, position.y + 5);
      ctx.moveTo(position.x + 5, position.y - 5);
      ctx.lineTo(position.x - 5, position.y + 5);
      ctx.stroke();

      draw_scores();
      reset_state();
    }, true);

    function start() {
      if (started) {
        return;
      }

      $('#initial').css({'display': 'none'});
      $('#main').css({'display': 'inline-block'});

      seed = parseInt($('#seed').val());

      start = true;
      load_random_image();
    }

    function reset_state() {
      timeOuts.forEach(function (element) {
        clearTimeout(element);
      });

      timeOuts = [];
    }

    function draw_scores() {
      $('#correct').text('Correct (you): ' + correct);
      $('#ourCorrect').text('Correct (AI): ' + our_correct);
      $('#total').text('Total Scans: ' + total);
    }

    function draw_truth() {
      // Ground Truth
      ctx.beginPath();
      ctx.strokeStyle = 'yellow';
      ctx.lineWidth = 3;
      ctx.rect(truth[0], truth[1], truth[2] - truth[0], truth[3] - truth[1]);
      ctx.stroke();

      ctx.beginPath();

      if (bb_intersection_over_union(truth, predicted) > 0.5) {
        ctx.strokeStyle = 'green';
      } else {
        ctx.strokeStyle = 'red';
      }

      ctx.lineWidth = 3;
      ctx.rect(predicted[0], predicted[1], predicted[2] - predicted[0], predicted[3] - predicted[1]);
      ctx.stroke();

      draw_scores();
    }

    function bb_intersection_over_union(boxA, boxB) {
      var xA = Math.max(boxA[0], boxB[0]);
      var yA = Math.max(boxA[1], boxB[1]);
      var xB = Math.min(boxA[2], boxB[2]);
      var yB = Math.min(boxA[3], boxB[3]);

      var interArea = Math.max(0, xB - xA + 1) * Math.max(0, yB - yA + 1);

      var boxAArea = (boxA[2] - boxA[0] + 1) * (boxA[3] - boxA[1] + 1);
      var boxBArea = (boxB[2] - boxB[0] + 1) * (boxB[3] - boxB[1] + 1);

      iou = interArea / (boxAArea + boxBArea - interArea);
      return iou
    }

    function load_random_image() {
      stop_timer();
      reset_state();
      draw_scores();

      update_seed();
      Math.seedrandom(seed);

      clicked = false;
      timeRemaining = 10;

      hinted = false;
      var id = random_file_number();
      var img = new Image();
      img.addEventListener("load", function () {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      });
      img.setAttribute("src", "content/images/" + id + ".png");

      $.getJSON("content/annotation/" + id + ".json", function (data) {
        truth = data['truth'];
        predicted = data['predicted'];

        if (bb_intersection_over_union(truth, predicted) > 0.5) {
          our_correct += 1;
        }
      });

      timeOuts.push(setTimeout(function () {
        draw_hint();
      }, 5000));

      timeOuts.push(setTimeout(function () {
        draw_truth();
      }, 10000));

      countdown = setInterval(function () {
        if (timeRemaining <= 0) {
          clearInterval(countdown);
        } else {
          $('#countdown').text('Time remaining: ' + (Math.round(timeRemaining * 10) / 10).toFixed(1) + 's');

          if (timeRemaining > 5) {
            $('#countdown').css({'color': '#373737'});
          } else if (timeRemaining > 2) {
            $('#countdown').css({'color': 'orange'});
          } else {
            $('#countdown').css({'color': 'red'});
          }
        }
        timeRemaining -= 0.1;
      }, 100);

      total += 1;
    }

    function stop_timer() {
      clearInterval(countdown);
    }

    function draw_hint() {
      if (hinted) {
        return;
      }

      hinted = true;

      var x = truth[0] + (truth[2] - truth[0]) / 2 + Math.random() * 100 - 50;
      var y = truth[1] + (truth[3] - truth[1]) / 2 + Math.random() * 100 - 50;

      ctx.beginPath();
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 2;
      ctx.arc(x, y, 100, 0, 2 * Math.PI);
      ctx.stroke();
    }

    $(document).keypress(function (e) {
      if (e.which === 32 || e.which === 115) { // S
        start();
      } else if (e.which === 78 || e.which === 110) { // N
        load_random_image();
      }
    });

    $('#seed').val(Math.round(Math.random() * 1000000));
  });
</script>
</body>
</html>
